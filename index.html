<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Inventory Dashboard</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap');

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: #0a0e27;
      color: #fff;
      min-height: 100vh;
      padding: 20px;
      position: relative;
      overflow-x: hidden;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(45deg, #ff006e, #8338ec, #3a86ff, #06ffa5);
      background-size: 400% 400%;
      animation: gradientShift 15s ease infinite;
      opacity: 0.1;
      z-index: 0;
      pointer-events: none;
    }

    @keyframes gradientShift {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    .dashboard-container {
      max-width: 1600px;
      margin: 0 auto;
      position: relative;
      z-index: 1;
    }

    .header {
      background: rgba(15, 20, 40, 0.9);
      backdrop-filter: blur(30px);
      border-radius: 25px;
      padding: 30px 40px;
      margin-bottom: 30px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 20px;
    }

    .header-left h1 {
      font-size: 2.5em;
      background: linear-gradient(135deg, #ff006e, #8338ec, #3a86ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 5px;
    }

    .header-left p {
      color: rgba(255, 255, 255, 0.6);
      font-size: 1em;
    }

    .header-sub {
      color: rgba(255, 255, 255, 0.5);
      font-size: 0.85em;
      margin-top: 4px;
    }

    .header-actions {
      display: flex;
      gap: 15px;
      align-items: center;
      flex-wrap: wrap;
    }

    .btn {
      background: linear-gradient(135deg, #ff006e, #8338ec);
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 50px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.95em;
      transition: all 0.3s ease;
      box-shadow: 0 10px 30px rgba(255, 0, 110, 0.3);
      font-family: 'Poppins', sans-serif;
      position: relative;
      overflow: hidden;
      white-space: nowrap;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      transition: left 0.5s;
    }

    .btn:hover::before {
      left: 100%;
    }

    .btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 15px 40px rgba(255, 0, 110, 0.5);
    }

    .btn:active {
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: linear-gradient(135deg, #3a86ff, #06ffa5);
      box-shadow: 0 10px 30px rgba(58, 134, 255, 0.3);
    }

    .btn-tertiary {
      background: linear-gradient(135deg, #ffa726, #ff006e);
      box-shadow: 0 10px 30px rgba(255, 167, 38, 0.3);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: rgba(15, 20, 40, 0.9);
      backdrop-filter: blur(30px);
      border-radius: 20px;
      padding: 25px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.05), transparent);
      transition: left 0.5s;
    }

    .stat-card:hover::before {
      left: 100%;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      border-color: rgba(255, 0, 110, 0.5);
      box-shadow: 0 15px 40px rgba(255, 0, 110, 0.3);
    }

    .stat-icon {
      width: 50px;
      height: 50px;
      border-radius: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5em;
      margin-bottom: 15px;
      background: linear-gradient(135deg, #ff006e, #8338ec);
    }

    .stat-label {
      color: rgba(255, 255, 255, 0.6);
      font-size: 0.9em;
      margin-bottom: 5px;
    }

    .stat-value {
      font-size: 2em;
      font-weight: 700;
      background: linear-gradient(135deg, #ff006e, #8338ec);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .stat-sub {
      font-size: 0.8em;
      color: rgba(255, 255, 255, 0.4);
      margin-top: 8px;
    }

    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .chart-container {
      background: rgba(15, 20, 40, 0.9);
      backdrop-filter: blur(30px);
      border-radius: 20px;
      padding: 25px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      position: relative;
    }

    .chart-title {
      font-size: 1.3em;
      margin-bottom: 20px;
      color: rgba(255, 255, 255, 0.9);
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .chart-title i {
      font-size: 1.2em;
    }

    canvas {
      max-height: 300px;
      cursor: pointer;
    }

    /* Enhanced Alerts Section */
    .alerts-section {
      background: linear-gradient(135deg, rgba(255, 0, 110, 0.1), rgba(131, 56, 236, 0.1));
      backdrop-filter: blur(30px);
      border-radius: 20px;
      padding: 25px;
      margin-bottom: 30px;
      border: 1px solid rgba(255, 0, 110, 0.2);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      position: relative;
      overflow: hidden;
    }

    .alerts-section::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #ff006e, #8338ec, #3a86ff);
    }

    .alerts-header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 20px;
    }

    .alerts-icon {
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, #ff006e, #8338ec);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5em;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .alerts-title {
      font-size: 1.5em;
      font-weight: 700;
      background: linear-gradient(135deg, #ff006e, #8338ec);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .alerts-subtitle {
      color: rgba(255, 255, 255, 0.7);
      font-size: 0.9em;
      margin-top: 5px;
    }

    .alerts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .alert-card {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 15px;
      padding: 20px;
      border-left: 4px solid;
      transition: all 0.3s ease;
    }

    .alert-card:hover {
      transform: translateX(5px);
      background: rgba(255, 255, 255, 0.08);
    }

    .alert-card.critical {
      border-left-color: #ff006e;
    }

    .alert-card.warning {
      border-left-color: #ffa726;
    }

    .alert-card.info {
      border-left-color: #3a86ff;
    }

    .alert-card.success {
      border-left-color: #06ffa5;
    }

    .alert-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .alert-icon {
      font-size: 1.2em;
    }

    .alert-title {
      font-weight: 600;
      font-size: 1em;
    }

    .alert-content {
      color: rgba(255, 255, 255, 0.8);
      font-size: 0.9em;
      line-height: 1.5;
    }

    .alert-timestamp {
      font-size: 0.8em;
      color: rgba(255, 255, 255, 0.5);
      margin-top: 10px;
    }

    /* Enhanced Accuracy Section */
    .accuracy-section {
      background: linear-gradient(135deg, rgba(58, 134, 255, 0.1), rgba(6, 255, 165, 0.1));
      backdrop-filter: blur(30px);
      border-radius: 20px;
      padding: 25px;
      margin-bottom: 30px;
      border: 1px solid rgba(58, 134, 255, 0.2);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .accuracy-header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 20px;
    }

    .accuracy-icon {
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, #3a86ff, #06ffa5);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5em;
    }

    .accuracy-title {
      font-size: 1.5em;
      font-weight: 700;
      background: linear-gradient(135deg, #3a86ff, #06ffa5);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .accuracy-content {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 30px;
      align-items: start;
    }

    .accuracy-input-area {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 15px;
      padding: 20px;
    }

    .accuracy-help {
      font-size: 0.9em;
      color: rgba(255, 255, 255, 0.7);
      margin-bottom: 15px;
      line-height: 1.5;
    }

    .accuracy-help code {
      background: rgba(255, 255, 255, 0.1);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: monospace;
    }

    .accuracy-input {
      width: 100%;
      min-height: 120px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      padding: 15px;
      color: #fff;
      font-family: 'Poppins', monospace;
      font-size: 0.9em;
      resize: vertical;
      transition: all 0.3s ease;
    }

    .accuracy-input:focus {
      outline: none;
      border-color: #06ffa5;
      box-shadow: 0 0 20px rgba(6, 255, 165, 0.3);
    }

    .accuracy-results {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 15px;
      padding: 20px;
    }

    .accuracy-metrics {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-bottom: 20px;
    }

    .metric-card {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      padding: 15px;
      text-align: center;
      transition: all 0.3s ease;
    }

    .metric-card:hover {
      transform: translateY(-3px);
      background: rgba(255, 255, 255, 0.08);
    }

    .metric-value {
      font-size: 1.8em;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .metric-label {
      font-size: 0.8em;
      color: rgba(255, 255, 255, 0.6);
    }

    .controls-section {
      background: rgba(15, 20, 40, 0.9);
      backdrop-filter: blur(30px);
      border-radius: 20px;
      padding: 25px;
      margin-bottom: 30px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .controls-grid {
      display: grid;
      grid-template-columns: 1fr auto auto;
      gap: 15px;
      align-items: center;
    }

    .search-box {
      position: relative;
    }

    .search-box input {
      width: 100%;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 50px;
      padding: 12px 20px 12px 45px;
      color: white;
      font-size: 0.95em;
      font-family: 'Poppins', sans-serif;
      transition: all 0.3s ease;
    }

    .search-box input:focus {
      outline: none;
      border-color: #ff006e;
      box-shadow: 0 0 20px rgba(255, 0, 110, 0.3);
    }

    .search-box::before {
      content: 'üîç';
      position: absolute;
      left: 18px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 1.2em;
    }

    .filter-select {
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 50px;
      padding: 12px 20px;
      color: white;
      font-size: 0.95em;
      font-family: 'Poppins', sans-serif;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .filter-select:focus {
      outline: none;
      border-color: #3a86ff;
      box-shadow: 0 0 20px rgba(58, 134, 255, 0.3);
    }

    .filter-select option {
      background: #0f1428;
      color: white;
    }

    .table-section {
      background: rgba(15, 20, 40, 0.9);
      backdrop-filter: blur(30px);
      border-radius: 20px;
      padding: 25px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      overflow: hidden;
    }

    .table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      gap: 10px;
      flex-wrap: wrap;
    }

    .table-title {
      font-size: 1.5em;
      font-weight: 600;
    }

    .table-wrapper {
      overflow-x: auto;
      max-height: 600px;
      border-radius: 15px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9em;
    }

    thead {
      position: sticky;
      top: 0;
      background: rgba(255, 0, 110, 0.1);
      backdrop-filter: blur(10px);
      z-index: 10;
    }

    th {
      padding: 15px;
      text-align: left;
      font-weight: 600;
      color: rgba(255, 255, 255, 0.9);
      border-bottom: 2px solid rgba(255, 0, 110, 0.3);
      white-space: nowrap;
    }

    td {
      padding: 15px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      color: rgba(255, 255, 255, 0.8);
    }

    tbody tr {
      transition: all 0.3s ease;
      cursor: pointer;
    }

    tbody tr:hover {
      background: rgba(255, 0, 110, 0.1);
      transform: scale(1.01);
    }

    .low-stock-row {
      background: rgba(255, 0, 110, 0.15);
      border-left: 4px solid #ff006e;
    }

    .low-stock-row:hover {
      background: rgba(255, 0, 110, 0.25);
    }

    .badge {
      display: inline-block;
      padding: 5px 12px;
      border-radius: 50px;
      font-size: 0.85em;
      font-weight: 600;
    }

    .badge-danger {
      background: rgba(255, 0, 110, 0.2);
      color: #ff006e;
      border: 1px solid #ff006e;
    }

    .badge-warning {
      background: rgba(255, 167, 38, 0.2);
      color: #ffa726;
      border: 1px solid #ffa726;
    }

    .badge-success {
      background: rgba(6, 255, 165, 0.2);
      color: #06ffa5;
      border: 1px solid #06ffa5;
    }

    .loading {
      text-align: center;
      padding: 60px;
      font-size: 1.2em;
      color: rgba(255, 255, 255, 0.6);
    }

    .spinner {
      width: 50px;
      height: 50px;
      margin: 0 auto 20px;
      border: 4px solid rgba(255, 255, 255, 0.1);
      border-top-color: #ff006e;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .table-wrapper::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }

    .table-wrapper::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
    }

    .table-wrapper::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, #ff006e, #8338ec);
      border-radius: 10px;
    }

    .table-wrapper::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(135deg, #8338ec, #3a86ff);
    }

    /* Enhanced Chatbot */
    .chatbot-toggle {
      position: fixed;
      right: 25px;
      bottom: 25px;
      width: 70px;
      height: 70px;
      border-radius: 50%;
      background: linear-gradient(135deg, #ff006e, #8338ec);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.8em;
      cursor: pointer;
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.6);
      z-index: 1000;
      transition: all 0.3s ease;
      border: 3px solid rgba(255, 255, 255, 0.2);
    }

    .chatbot-toggle:hover {
      transform: scale(1.1) rotate(10deg);
      box-shadow: 0 20px 50px rgba(255, 0, 110, 0.5);
    }

    .chatbot-toggle.pulse {
      animation: chatbotPulse 2s infinite;
    }

    @keyframes chatbotPulse {
      0%, 100% { box-shadow: 0 15px 40px rgba(255, 0, 110, 0.6); }
      50% { box-shadow: 0 15px 50px rgba(255, 0, 110, 0.8); }
    }

    .chatbot-toggle::before {
      content: '';
      position: absolute;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background: linear-gradient(135deg, #ff006e, #8338ec);
      animation: rotate 3s linear infinite;
      z-index: -1;
      opacity: 0.5;
    }

    @keyframes rotate {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .chatbot-window {
      position: fixed;
      right: 25px;
      bottom: 110px;
      width: 380px;
      height: 550px;
      background: rgba(15, 20, 40, 0.98);
      border-radius: 20px;
      border: 1px solid rgba(255, 255, 255, 0.15);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
      display: none;
      flex-direction: column;
      overflow: hidden;
      z-index: 1001;
      backdrop-filter: blur(20px);
    }

    .chatbot-window.active {
      display: flex;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .chatbot-header {
      padding: 15px 20px;
      background: linear-gradient(135deg, #ff006e, #8338ec);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .chatbot-header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .chatbot-logo {
      width: 40px;
      height: 40px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2em;
    }

    .chatbot-header-title {
      font-weight: 600;
      font-size: 1.1em;
    }

    .chatbot-header-sub {
      font-size: 0.75em;
      opacity: 0.9;
    }

    .chatbot-controls {
      display: flex;
      gap: 10px;
    }

    .chatbot-btn {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .chatbot-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.1);
    }

    .chatbot-btn.voice {
      background: rgba(6, 255, 165, 0.3);
    }

    .chatbot-btn.voice.active {
      background: #06ffa5;
      animation: voicePulse 1s infinite;
    }

    @keyframes voicePulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(6, 255, 165, 0.7); }
      50% { box-shadow: 0 0 0 10px rgba(6, 255, 165, 0); }
    }

    .chatbot-messages {
      padding: 15px;
      flex: 1;
      overflow-y: auto;
      font-size: 0.85em;
      background: rgba(0, 0, 0, 0.2);
    }

    .chat-message {
      margin-bottom: 12px;
      display: flex;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .chat-message.bot {
      justify-content: flex-start;
    }

    .chat-message.user {
      justify-content: flex-end;
    }

    .message-bubble {
      max-width: 80%;
      padding: 10px 15px;
      border-radius: 18px;
      line-height: 1.5;
      position: relative;
    }

    .message-bubble.bot {
      background: rgba(255, 255, 255, 0.1);
      border-top-left-radius: 5px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .message-bubble.user {
      background: linear-gradient(135deg, #3a86ff, #06ffa5);
      border-top-right-radius: 5px;
    }

    .message-time {
      font-size: 0.7em;
      opacity: 0.6;
      margin-top: 5px;
      text-align: right;
    }

    .chatbot-input-area {
      display: flex;
      padding: 15px;
      background: rgba(0, 0, 0, 0.3);
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      gap: 10px;
    }

    .chatbot-input {
      flex: 1;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 25px;
      padding: 10px 15px;
      color: white;
      font-size: 0.9em;
      font-family: 'Poppins', sans-serif;
      transition: all 0.3s ease;
    }

    .chatbot-input:focus {
      outline: none;
      border-color: #3a86ff;
      box-shadow: 0 0 15px rgba(58, 134, 255, 0.3);
    }

    .chatbot-send-btn {
      background: linear-gradient(135deg, #ff006e, #8338ec);
      border: none;
      border-radius: 25px;
      padding: 10px 25px;
      color: white;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .chatbot-send-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 5px 20px rgba(255, 0, 110, 0.4);
    }

    /* Product Detail Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      animation: fadeIn 0.3s ease;
    }

    .modal-overlay.active {
      display: flex;
    }

    .product-modal {
      background: rgba(15, 20, 40, 0.95);
      border-radius: 25px;
      padding: 30px;
      width: 90%;
      max-width: 500px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(50px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
    }

    .modal-title {
      font-size: 1.5em;
      font-weight: 700;
      background: linear-gradient(135deg, #ff006e, #8338ec);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .modal-close {
      background: none;
      border: none;
      color: rgba(255, 255, 255, 0.6);
      font-size: 1.5em;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .modal-close:hover {
      color: #ff006e;
      transform: rotate(90deg);
    }

    .product-info-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      margin-bottom: 25px;
    }

    .info-card {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 15px;
      padding: 20px;
      text-align: center;
      transition: all 0.3s ease;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .info-card:hover {
      transform: translateY(-5px);
      background: rgba(255, 255, 255, 0.08);
    }

    .info-label {
      font-size: 0.9em;
      color: rgba(255, 255, 255, 0.6);
      margin-bottom: 10px;
    }

    .info-value {
      font-size: 1.8em;
      font-weight: 700;
    }

    .info-value.stock-low {
      color: #ff006e;
    }

    .info-value.stock-ok {
      color: #06ffa5;
    }

    .info-value.demand-high {
      color: #ffa726;
    }

    .product-stats {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 25px;
    }

    .stat-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .stat-row:last-child {
      border-bottom: none;
    }

    .stat-label {
      color: rgba(255, 255, 255, 0.7);
    }

    .stat-value {
      font-weight: 600;
    }

    .modal-actions {
      display: flex;
      gap: 15px;
    }

    .modal-actions .btn {
      flex: 1;
    }

    @media (max-width: 1200px) {
      .charts-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        align-items: flex-start;
      }

      .controls-grid {
        grid-template-columns: 1fr;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .header-left h1 {
        font-size: 1.8em;
      }

      .accuracy-content {
        grid-template-columns: 1fr;
      }

      .alerts-grid {
        grid-template-columns: 1fr;
      }

      .product-info-grid {
        grid-template-columns: 1fr;
      }

      .chatbot-window {
        width: 90%;
        right: 5%;
        bottom: 100px;
        height: 60vh;
      }
    }
  </style>
</head>
<body>
  <div class="dashboard-container">
    <div class="header">
      <div class="header-left">
        <h1>üìä Smart Inventory Dashboard</h1>
        <p>AI-Powered Demand Forecasting & Analytics</p>
        <div class="header-sub" id="lastRunText">No prediction run yet</div>
      </div>
      <div class="header-actions">
        <button class="btn" onclick="loadPredictions()" id="loadBtn">
          üöÄ Load Predictions
        </button>
        <button class="btn btn-secondary" onclick="exportCSV()" id="exportBtn" disabled>
          üì• Export CSV
        </button>
      </div>
    </div>

    <div class="stats-grid" id="statsGrid">
      <div class="stat-card">
        <div class="stat-icon">üì¶</div>
        <div class="stat-label">Total Products</div>
        <div class="stat-value" id="totalProducts">-</div>
        <div class="stat-sub">From latest prediction</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">‚ö†Ô∏è</div>
        <div class="stat-label">Low Stock Items</div>
        <div class="stat-value" id="lowStockItems">-</div>
        <div class="stat-sub">Current stock below threshold</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">üìà</div>
        <div class="stat-label">Total Predicted Demand</div>
        <div class="stat-value" id="totalDemand">-</div>
        <div class="stat-sub">Sum of all forecasted units</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">üîÑ</div>
        <div class="stat-label">Restock Required</div>
        <div class="stat-value" id="restockRequired">-</div>
        <div class="stat-sub">Products needing action</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">üéØ</div>
        <div class="stat-label">Prediction Accuracy</div>
        <div class="stat-value" id="accuracyScore">-</div>
        <div class="stat-sub" id="accuracySub">Paste actuals to compute</div>
      </div>
    </div>

    <div class="charts-grid">
      <div class="chart-container">
        <h3 class="chart-title"><i>üìä</i> Top 10 Predicted Demand <span style="font-size:0.8em; color:rgba(255,255,255,0.6)">(Click any bar for details)</span></h3>
        <canvas id="demandChart"></canvas>
      </div>
      <div class="chart-container">
        <h3 class="chart-title"><i>üìà</i> Stock vs Demand Trend</h3>
        <canvas id="trendChart"></canvas>
      </div>
    </div>

    <!-- Enhanced Alerts Section -->
    <div class="alerts-section">
      <div class="alerts-header">
        <div class="alerts-icon">üîî</div>
        <div>
          <div class="alerts-title">Smart Alerts</div>
          <div class="alerts-subtitle">AI-powered insights and recommendations</div>
        </div>
      </div>
      <div class="alerts-grid" id="alertsGrid">
        <div class="alert-card critical">
          <div class="alert-header">
            <div class="alert-icon">‚ö†Ô∏è</div>
            <div class="alert-title">Critical Stock Alert</div>
          </div>
          <div class="alert-content" id="criticalAlert">Loading...</div>
          <div class="alert-timestamp" id="criticalTime"></div>
        </div>
        <div class="alert-card warning">
          <div class="alert-header">
            <div class="alert-icon">üîÑ</div>
            <div class="alert-title">Restock Recommendations</div>
          </div>
          <div class="alert-content" id="restockAlert">Loading...</div>
          <div class="alert-timestamp" id="restockTime"></div>
        </div>
        <div class="alert-card info">
          <div class="alert-header">
            <div class="alert-icon">üìà</div>
            <div class="alert-title">Demand Insights</div>
          </div>
          <div class="alert-content" id="demandAlert">Loading...</div>
          <div class="alert-timestamp" id="demandTime"></div>
        </div>
        <div class="alert-card success">
          <div class="alert-header">
            <div class="alert-icon">‚úÖ</div>
            <div class="alert-title">Healthy Inventory</div>
          </div>
          <div class="alert-content" id="healthyAlert">Loading...</div>
          <div class="alert-timestamp" id="healthyTime"></div>
        </div>
      </div>
    </div>

    <!-- Enhanced Accuracy Section -->
    <div class="accuracy-section">
      <div class="accuracy-header">
        <div class="accuracy-icon">üéØ</div>
        <div>
          <div class="accuracy-title">Prediction Accuracy</div>
          <div class="alerts-subtitle">Measure forecast precision with actual sales data</div>
        </div>
      </div>
      <div class="accuracy-content">
        <div class="accuracy-input-area">
          <div class="accuracy-help">
            <strong>How to calculate accuracy:</strong><br>
            Paste your actual sales data (one product per line) in any format:<br>
            <code>83, 45</code> or <code>PRODUCT83, 45</code> or <code>P83, 45</code><br>
            <code>86, 42</code> or <code>PRODUCT86, 42</code> or <code>P86, 42</code><br>
            The system will automatically extract product IDs and match them.
          </div>
          <textarea 
            class="accuracy-input" 
            id="actualInput" 
            placeholder="83, 45&#10;86, 42&#10;88, 35"
            oninput="updateAccuracyPreview()"
          ></textarea>
          <div style="margin-top: 10px; font-size: 0.8em; color: rgba(255,255,255,0.6);" id="previewText">
            Lines detected: 0
          </div>
        </div>
        <div class="accuracy-results">
          <div class="accuracy-metrics">
            <div class="metric-card">
              <div class="metric-value" id="accuracyMetric">-</div>
              <div class="metric-label">Accuracy %</div>
            </div>
            <div class="metric-card">
              <div class="metric-value" id="rmseMetric">-</div>
              <div class="metric-label">RMSE</div>
            </div>
            <div class="metric-card">
              <div class="metric-value" id="biasMetric">-</div>
              <div class="metric-label">Bias</div>
            </div>
            <div class="metric-card">
              <div class="metric-value" id="samplesMetric">0</div>
              <div class="metric-label">Samples</div>
            </div>
          </div>
          <button class="btn btn-secondary" style="width: 100%;" onclick="calculateAccuracy()" id="calculateBtn" disabled>
            üéØ Calculate Accuracy
          </button>
          <div style="margin-top: 15px; font-size: 0.85em; color: rgba(255,255,255,0.7);" id="accuracyResult">
            Results will appear here after calculation
          </div>
        </div>
      </div>
    </div>

    <div class="controls-section">
      <div class="controls-grid">
        <div class="search-box">
          <input type="text" id="searchInput" placeholder="Search products..." oninput="filterTable()">
        </div>
        <select class="filter-select" id="stockFilter" onchange="filterTable()">
          <option value="all">All Stock Levels</option>
          <option value="low">Low Stock Only</option>
          <option value="adequate">Adequate Stock</option>
        </select>
        <select class="filter-select" id="sortFilter" onchange="filterTable()">
          <option value="id">Sort by ID</option>
          <option value="demand">Sort by Demand</option>
          <option value="stock">Sort by Stock</option>
          <option value="restock">Sort by Restock</option>
        </select>
      </div>
    </div>

    <div class="table-section">
      <div class="table-header">
        <h3 class="table-title">üì¶ Complete Inventory Data</h3>
        <span id="tableCount">0 products</span>
      </div>
      <div class="table-wrapper">
        <table id="dataTable">
          <thead>
            <tr>
              <th>Product ID</th>
              <th>Total Sales</th>
              <th>Current Stock</th>
              <th>Predicted Demand</th>
              <th>Recommended Restock</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="tableBody">
            <tr>
              <td colspan="6" class="loading">
                <div class="spinner"></div>
                Click "Load Predictions" to fetch data
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Product Detail Modal -->
  <div class="modal-overlay" id="productModal">
    <div class="product-modal">
      <div class="modal-header">
        <h3 class="modal-title" id="modalProductTitle">Product Details</h3>
        <button class="modal-close" onclick="closeModal()">‚úï</button>
      </div>
      <div class="product-info-grid">
        <div class="info-card">
          <div class="info-label">Current Stock</div>
          <div class="info-value" id="modalStock">-</div>
        </div>
        <div class="info-card">
          <div class="info-label">Predicted Demand</div>
          <div class="info-value" id="modalDemand">-</div>
        </div>
        <div class="info-card">
          <div class="info-label">Total Sales</div>
          <div class="info-value" id="modalSales">-</div>
        </div>
        <div class="info-card">
          <div class="info-label">Restock Needed</div>
          <div class="info-value" id="modalRestock">-</div>
        </div>
      </div>
      <div class="product-stats">
        <div class="stat-row">
          <span class="stat-label">Stock Status</span>
          <span class="stat-value" id="modalStatus">-</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Stock to Demand Ratio</span>
          <span class="stat-value" id="modalRatio">-</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Safety Margin</span>
          <span class="stat-value" id="modalMargin">-</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Urgency Level</span>
          <span class="stat-value" id="modalUrgency">-</span>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn" onclick="focusOnProduct()">
          üìç Find in Table
        </button>
        <button class="btn btn-tertiary" onclick="exportProductReport()">
          üìÑ Export Report
        </button>
      </div>
    </div>
  </div>

  <!-- Enhanced Chatbot -->
  <div class="chatbot-toggle" id="chatbotToggle" onclick="toggleChatbot()">
    <div style="position: relative; display: flex; align-items: center; justify-content: center;">
      <div style="position: absolute; width: 100%; height: 100%; background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/></svg>') center no-repeat; opacity: 0.8;"></div>
    </div>
  </div>

  <div class="chatbot-window" id="chatbotWindow">
    <div class="chatbot-header">
      <div class="chatbot-header-left">
        <div class="chatbot-logo">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M20 2H4C2.9 2 2 2.9 2 4V22L6 18H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2Z" fill="white"/>
            <circle cx="7" cy="12" r="1" fill="#0a0e27"/>
            <circle cx="12" cy="12" r="1" fill="#0a0e27"/>
            <circle cx="17" cy="12" r="1" fill="#0a0e27"/>
          </svg>
        </div>
        <div>
          <div class="chatbot-header-title">Inventory AI Assistant</div>
          <div class="chatbot-header-sub">Ask about stock, demand, accuracy</div>
        </div>
      </div>
      <div class="chatbot-controls">
        <button class="chatbot-btn voice" id="voiceBtn" onclick="toggleVoice()" title="Voice Input">
          üé§
        </button>
        <button class="chatbot-btn" onclick="clearChat()" title="Clear Chat">
          üóëÔ∏è
        </button>
        <button class="chatbot-btn" onclick="toggleChatbot()" title="Close">
          ‚úï
        </button>
      </div>
    </div>
    <div class="chatbot-messages" id="chatMessages">
      <div class="chat-message bot">
        <div class="message-bubble bot">
          Hello! I'm your Inventory AI Assistant. ü§ñ<br><br>
          I can help you with:<br>
          ‚Ä¢ üìä Low stock alerts<br>
          ‚Ä¢ üìà Demand forecasts<br>
          ‚Ä¢ üîÑ Restock recommendations<br>
          ‚Ä¢ üéØ Prediction accuracy<br><br>
          Try saying "Show low stock items" or click the üé§ button for voice input!
          <div class="message-time" id="initTime"></div>
        </div>
      </div>
    </div>
    <div class="chatbot-input-area">
      <input type="text" class="chatbot-input" id="chatInput" placeholder="Type your question..." 
        onkeydown="if(event.key==='Enter'){sendChat()}"
        oninput="updateSendButton()">
      <button class="chatbot-send-btn" id="sendBtn" onclick="sendChat()">Send</button>
    </div>
  </div>

  <script>
    let allData = [];
    let demandChart = null;
    let trendChart = null;
    let lastAccuracy = null;
    let selectedProductId = null;
    let isListening = false;
    let recognition = null;

    // Initialize voice recognition if available
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.continuous = false;
      recognition.interimResults = false;
      recognition.lang = 'en-US';

      recognition.onresult = function(event) {
        const transcript = event.results[0][0].transcript;
        document.getElementById('chatInput').value = transcript;
        updateSendButton();
      };

      recognition.onerror = function(event) {
        console.error('Speech recognition error:', event.error);
        addChatMessage('bot', 'Sorry, I had trouble understanding your voice. Please try typing instead.');
        document.getElementById('voiceBtn').classList.remove('active');
        isListening = false;
      };

      recognition.onend = function() {
        document.getElementById('voiceBtn').classList.remove('active');
        isListening = false;
      };
    }

    function toggleVoice() {
      if (!recognition) {
        addChatMessage('bot', 'Voice recognition is not supported in your browser. Please use text input.');
        return;
      }

      const voiceBtn = document.getElementById('voiceBtn');
      
      if (!isListening) {
        recognition.start();
        voiceBtn.classList.add('active');
        isListening = true;
        addChatMessage('bot', 'üé§ Listening... Please speak now.');
      } else {
        recognition.stop();
        voiceBtn.classList.remove('active');
        isListening = false;
        addChatMessage('bot', 'üé§ Voice input stopped.');
      }
    }

    function updateSendButton() {
      const input = document.getElementById('chatInput');
      const sendBtn = document.getElementById('sendBtn');
      sendBtn.disabled = !input.value.trim();
    }

    function setLastRunText() {
      const el = document.getElementById('lastRunText');
      const now = new Date();
      el.textContent = 'Last run: ' + now.toLocaleString();
    }

    async function loadPredictions() {
      const btn = document.getElementById('loadBtn');
      const exportBtn = document.getElementById('exportBtn');
      const tbody = document.getElementById('tableBody');

      btn.disabled = true;
      tbody.innerHTML = '<tr><td colspan="6" class="loading"><div class="spinner"></div>Loading predictions...</td></tr>';
      
      // Set initial alert states
      document.getElementById('criticalAlert').textContent = 'Analyzing inventory data...';
      document.getElementById('restockAlert').textContent = 'Processing recommendations...';
      document.getElementById('demandAlert').textContent = 'Calculating demand patterns...';
      document.getElementById('healthyAlert').textContent = 'Evaluating stock health...';

      try {
        const res = await fetch('http://localhost:3000/predict', {
          method: 'POST'
        });

        if (!res.ok) throw new Error('Failed to fetch predictions');

        const data = await res.json();
        allData = data.predictions || [];

        if (allData.length === 0) {
          throw new Error('No predictions returned');
        }

        updateStats();
        renderCharts();
        renderTable(allData);
        updateAlerts();
        exportBtn.disabled = false;
        setLastRunText();

        // Add success message to chatbot
        addChatMessage('bot', `‚úÖ Successfully loaded ${allData.length} product predictions! I'm ready to help you analyze the inventory.`);

      } catch (err) {
        tbody.innerHTML = '<tr><td colspan="6" class="loading">‚ùå Error: ' + err.message +
          '<br><br>Please ensure backend is running at http://localhost:3000</td></tr>';
        console.error(err);
        
        // Update alerts with error state
        document.getElementById('criticalAlert').textContent = 'Error loading predictions';
        document.getElementById('criticalAlert').parentElement.classList.add('critical');
        document.getElementById('criticalTime').textContent = 'Just now';
        
        addChatMessage('bot', '‚ùå Failed to load predictions. Please check if the backend server is running.');
      } finally {
        btn.disabled = false;
      }
    }

    function updateStats() {
      const lowStockThreshold = 50;
      const lowStock = allData.filter(p => p.current_stock < lowStockThreshold).length;
      const totalDemand = allData.reduce((sum, p) => sum + (p.predicted_demand || 0), 0);
      const restockNeeded = allData.filter(p => (p.recommended_restock || 0) > 0).length;

      document.getElementById('totalProducts').textContent = allData.length;
      document.getElementById('lowStockItems').textContent = lowStock;
      document.getElementById('totalDemand').textContent = Math.round(totalDemand);
      document.getElementById('restockRequired').textContent = restockNeeded;

      if (!lastAccuracy) {
        document.getElementById('accuracyScore').textContent = '-';
        document.getElementById('accuracySub').textContent = 'Paste actuals to compute';
      }
    }

    function renderCharts() {
      const top10 = [...allData]
        .sort((a, b) => (b.predicted_demand || 0) - (a.predicted_demand || 0))
        .slice(0, 10);

      const demandCtx = document.getElementById('demandChart').getContext('2d');

      if (demandChart) demandChart.destroy();

      demandChart = new Chart(demandCtx, {
        type: 'bar',
        data: {
          labels: top10.map(p => 'P' + p.product_id),
          datasets: [{
            label: 'Predicted Demand',
            data: top10.map(p => p.predicted_demand),
            backgroundColor: top10.map((p, i) => 
              `rgba(${255 - i * 20}, ${100 + i * 15}, ${110 + i * 10}, 0.7)`
            ),
            borderColor: top10.map((p, i) => 
              `rgb(${255 - i * 20}, ${100 + i * 15}, ${110 + i * 10})`
            ),
            borderWidth: 2,
            borderRadius: 8,
            hoverBackgroundColor: top10.map(() => 'rgba(255, 0, 110, 0.9)'),
            hoverBorderColor: top10.map(() => '#ff006e'),
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const productId = context.label;
                  const product = allData.find(p => 'P' + p.product_id === productId);
                  if (product) {
                    return [
                      `Product: ${productId}`,
                      `Demand: ${context.parsed.y} units`,
                      `Current Stock: ${product.current_stock}`,
                      `Sales: ${product.total_sales}`,
                      `Click for details`
                    ];
                  }
                  return `Demand: ${context.parsed.y} units`;
                }
              }
            }
          },
          onClick: function(evt, elements) {
            if (elements.length > 0) {
              const index = elements[0].index;
              const productId = this.data.labels[index].replace('P', '');
              showProductDetails(productId);
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: { color: 'rgba(255, 255, 255, 0.05)' },
              ticks: { color: 'rgba(255, 255, 255, 0.7)' }
            },
            x: {
              grid: { display: false },
              ticks: { 
                color: 'rgba(255, 255, 255, 0.7)',
                callback: function(value, index) {
                  return this.getLabelForValue(index);
                }
              }
            }
          }
        }
      });

      const top20 = [...allData]
        .sort((a, b) => (b.predicted_demand || 0) - (a.predicted_demand || 0))
        .slice(0, 20);

      const trendCtx = document.getElementById('trendChart').getContext('2d');

      if (trendChart) trendChart.destroy();

      trendChart = new Chart(trendCtx, {
        type: 'line',
        data: {
          labels: top20.map(p => 'P' + p.product_id),
          datasets: [
            {
              label: 'Current Stock',
              data: top20.map(p => p.current_stock),
              borderColor: '#3a86ff',
              backgroundColor: 'rgba(58, 134, 255, 0.1)',
              tension: 0.4,
              fill: true,
              pointBackgroundColor: top20.map(p => 
                p.current_stock < 30 ? '#ff006e' : 
                p.current_stock < 50 ? '#ffa726' : '#06ffa5'
              ),
              pointBorderColor: '#fff',
              pointBorderWidth: 2,
              pointRadius: 5,
              pointHoverRadius: 7
            },
            {
              label: 'Predicted Demand',
              data: top20.map(p => p.predicted_demand),
              borderColor: '#ff006e',
              backgroundColor: 'rgba(255, 0, 110, 0.1)',
              tension: 0.4,
              fill: false,
              borderDash: [5, 5],
              pointStyle: 'rect',
              pointRadius: 4
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              labels: { color: 'rgba(255, 255, 255, 0.8)' }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: { color: 'rgba(255, 255, 255, 0.05)' },
              ticks: { color: 'rgba(255, 255, 255, 0.7)' }
            },
            x: {
              grid: { display: false },
              ticks: { color: 'rgba(255, 255, 255, 0.7)' }
            }
          }
        }
      });
    }

    function showProductDetails(productId) {
      const product = allData.find(p => p.product_id == productId);
      if (!product) return;

      selectedProductId = productId;
      
      // Update modal content
      document.getElementById('modalProductTitle').textContent = `Product P${productId} Details`;
      document.getElementById('modalStock').textContent = product.current_stock;
      document.getElementById('modalDemand').textContent = product.predicted_demand || 0;
      document.getElementById('modalSales').textContent = product.total_sales || 0;
      document.getElementById('modalRestock').textContent = product.recommended_restock || 0;
      
      // Style values based on thresholds
      const stockEl = document.getElementById('modalStock');
      const demandEl = document.getElementById('modalDemand');
      
      if (product.current_stock < 30) {
        stockEl.className = 'info-value stock-low';
        stockEl.innerHTML = `${product.current_stock} <span style="font-size:0.6em">(CRITICAL)</span>`;
      } else if (product.current_stock < 50) {
        stockEl.className = 'info-value stock-low';
        stockEl.innerHTML = `${product.current_stock} <span style="font-size:0.6em">(LOW)</span>`;
      } else {
        stockEl.className = 'info-value stock-ok';
      }
      
      if (product.predicted_demand > 100) {
        demandEl.className = 'info-value demand-high';
        demandEl.innerHTML = `${product.predicted_demand} <span style="font-size:0.6em">(HIGH)</span>`;
      }
      
      // Calculate additional metrics
      const ratio = product.current_stock / (product.predicted_demand || 1);
      const margin = Math.max(0, product.current_stock - (product.predicted_demand || 0));
      let urgency = 'Low';
      
      if (product.current_stock < 20) urgency = 'Critical';
      else if (product.current_stock < 40) urgency = 'High';
      else if (product.current_stock < 60) urgency = 'Medium';
      
      document.getElementById('modalStatus').textContent = 
        product.current_stock < 30 ? '‚ö†Ô∏è Critical' : 
        product.current_stock < 50 ? 'üü° Low' : '‚úÖ Adequate';
      
      document.getElementById('modalRatio').textContent = ratio.toFixed(2);
      document.getElementById('modalMargin').textContent = margin;
      document.getElementById('modalUrgency').textContent = urgency;
      
      // Show modal
      document.getElementById('productModal').classList.add('active');
    }

    function closeModal() {
      document.getElementById('productModal').classList.remove('active');
    }

    function focusOnProduct() {
      if (!selectedProductId) return;
      
      closeModal();
      
      // Find and scroll to the product in table
      const rows = document.querySelectorAll('#tableBody tr');
      rows.forEach((row, index) => {
        if (row.cells[0] && row.cells[0].textContent.includes(selectedProductId)) {
          row.scrollIntoView({ behavior: 'smooth', block: 'center' });
          row.style.animation = 'pulse 2s';
          setTimeout(() => row.style.animation = '', 2000);
        }
      });
    }

    function exportProductReport() {
      if (!selectedProductId) return;
      
      const product = allData.find(p => p.product_id == selectedProductId);
      if (!product) return;
      
      const report = `Product P${selectedProductId} Report\n` +
        `Generated: ${new Date().toLocaleString()}\n\n` +
        `üìä PRODUCT DETAILS\n` +
        `Current Stock: ${product.current_stock}\n` +
        `Predicted Demand: ${product.predicted_demand || 0}\n` +
        `Total Sales: ${product.total_sales || 0}\n` +
        `Recommended Restock: ${product.recommended_restock || 0}\n\n` +
        `üìà ANALYSIS\n` +
        `Stock Status: ${product.current_stock < 30 ? 'Critical' : product.current_stock < 50 ? 'Low' : 'Adequate'}\n` +
        `Stock/Demand Ratio: ${(product.current_stock / (product.predicted_demand || 1)).toFixed(2)}\n` +
        `Safety Margin: ${Math.max(0, product.current_stock - (product.predicted_demand || 0))}\n` +
        `Urgency: ${product.current_stock < 20 ? 'Critical' : product.current_stock < 40 ? 'High' : product.current_stock < 60 ? 'Medium' : 'Low'}\n\n` +
        `üí° RECOMMENDATION\n` +
        `${product.recommended_restock > 0 ? `Restock ${product.recommended_restock} units immediately.` : 'No immediate restock needed.'}`;
      
      const blob = new Blob([report], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `product_${selectedProductId}_report_${new Date().toISOString().split('T')[0]}.txt`;
      a.click();
      URL.revokeObjectURL(url);
      
      addChatMessage('bot', `‚úÖ Exported detailed report for Product P${selectedProductId}`);
    }

    function renderTable(data) {
      const tbody = document.getElementById('tableBody');
      const lowStockThreshold = 50;

      if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="loading">No data to display</td></tr>';
        document.getElementById('tableCount').textContent = '0 products';
        return;
      }

      tbody.innerHTML = data.map(p => {
        const isLowStock = p.current_stock < lowStockThreshold;
        const statusBadge = isLowStock 
          ? '<span class="badge badge-danger">‚ö†Ô∏è Low Stock</span>'
          : (p.recommended_restock || 0) > 0
            ? '<span class="badge badge-warning">üîÑ Restock Soon</span>'
            : '<span class="badge badge-success">‚úì Adequate</span>';

        const restockColor = (p.recommended_restock || 0) > 0 ? '#ff006e' : '#06ffa5';

        return (
          '<tr onclick="showProductDetails(\'' + p.product_id + '\')" class="' + (isLowStock ? 'low-stock-row' : '') + '" data-id="' + p.product_id + '">' +
          '<td><strong>P' + p.product_id + '</strong></td>' +
          '<td>' + p.total_sales + '</td>' +
          '<td>' + p.current_stock + '</td>' +
          '<td><strong>' + p.predicted_demand + '</strong></td>' +
          '<td><strong style="color:' + restockColor + '">' + p.recommended_restock + '</strong></td>' +
          '<td>' + statusBadge + '</td>' +
          '</tr>'
        );
      }).join('');

      document.getElementById('tableCount').textContent = data.length + ' products';
    }

    function filterTable() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const stockFilter = document.getElementById('stockFilter').value;
      const sortBy = document.getElementById('sortFilter').value;
      const lowStockThreshold = 50;

      let filtered = allData.filter(p => {
        const matchesSearch = ('P' + p.product_id).toLowerCase().includes(searchTerm);
        let matchesStock = true;
        if (stockFilter === 'low') {
          matchesStock = p.current_stock < lowStockThreshold;
        } else if (stockFilter === 'adequate') {
          matchesStock = p.current_stock >= lowStockThreshold;
        }
        return matchesSearch && matchesStock;
      });

      filtered.sort((a, b) => {
        switch(sortBy) {
          case 'demand': return (b.predicted_demand || 0) - (a.predicted_demand || 0);
          case 'stock': return a.current_stock - b.current_stock;
          case 'restock': return (b.recommended_restock || 0) - (a.recommended_restock || 0);
          default: return parseInt(a.product_id) - parseInt(b.product_id);
        }
      });

      renderTable(filtered);
    }

    function updateAccuracyPreview() {
      const text = document.getElementById('actualInput').value.trim();
      const lines = text.split('\n').filter(line => line.trim().length > 0);
      
      // Parse and count valid lines
      let validLines = 0;
      let sampleIds = [];
      
      lines.forEach(line => {
        const clean = line.trim();
        if (!clean) return;
        
        const cleanLine = clean.replace(/[\[\]]/g, '');
        const parts = cleanLine.split(/[,: ]+/).map(x => x.trim()).filter(Boolean);
        
        if (parts.length >= 2 && !isNaN(parseFloat(parts[1]))) {
          validLines++;
          if (sampleIds.length < 3) {
            sampleIds.push(parts[0]);
          }
        }
      });
      
      let previewText = `Lines detected: ${lines.length}`;
      if (validLines > 0) {
        previewText += ` | Valid entries: ${validLines}`;
        if (sampleIds.length > 0) {
          previewText += ` | Sample IDs: ${sampleIds.join(', ')}`;
        }
      }
      
      document.getElementById('previewText').textContent = previewText;
      
      if (validLines > 0) {
        document.getElementById('calculateBtn').disabled = false;
      } else {
        document.getElementById('calculateBtn').disabled = true;
      }
    }

    function calculateAccuracy() {
      if (allData.length === 0) {
        alert('Please load predictions first.');
        return;
      }

      const text = document.getElementById('actualInput').value.trim();
      const resultEl = document.getElementById('accuracyResult');

      if (!text) {
        resultEl.innerHTML = '<span style="color:#ffa726">‚ö†Ô∏è Please paste some actual sales data.</span>';
        return;
      }

      const lines = text.split('\n');
      const actuals = {};
      
      // Parse all lines for actual data
      lines.forEach(line => {
        const clean = line.trim();
        if (!clean) return;
        
        // Try multiple parsing patterns
        // Remove brackets if present
        const cleanLine = clean.replace(/[\[\]]/g, '');
        
        // Split by comma, colon, or space
        const parts = cleanLine.split(/[,: ]+/).map(x => x.trim()).filter(Boolean);
        
        if (parts.length < 2) return;
        
        const idPart = parts[0].toUpperCase();
        const val = parseFloat(parts[1]);
        
        if (isNaN(val)) return;
        
        // Extract numeric ID from various formats
        let productId = null;
        
        // Try to extract numbers from the ID part
        const numbers = idPart.match(/\d+/g);
        if (numbers && numbers.length > 0) {
          productId = numbers[0]; // Take first number found
        }
        
        // If no numbers found, use the entire ID part (for "P1", "P2", etc)
        if (!productId) {
          productId = idPart;
        }
        
        // Store with the extracted ID
        actuals[productId] = val;
      });

      console.log('Actuals parsed:', actuals);

      const errors = [];
      let sumSq = 0;
      let sumAbsPct = 0;
      let countPct = 0;
      let sumBias = 0;
      let pairs = 0;
      let matchedProducts = [];

      // Try to match predictions with actuals
      allData.forEach(p => {
        const productId = String(p.product_id);
        
        // Try multiple matching strategies
        let actual = null;
        
        // Strategy 1: Direct match (e.g., "83" matches "83")
        if (actuals[productId] !== undefined) {
          actual = actuals[productId];
        }
        // Strategy 2: Try "PRODUCT" + ID (e.g., "PRODUCT83")
        else if (actuals['PRODUCT' + productId] !== undefined) {
          actual = actuals['PRODUCT' + productId];
        }
        // Strategy 3: Try "P" + ID (e.g., "P83")
        else if (actuals['P' + productId] !== undefined) {
          actual = actuals['P' + productId];
        }
        // Strategy 4: Remove "PRODUCT" prefix and try (e.g., "83" from "PRODUCT83")
        else if (actuals[productId.replace('PRODUCT', '')] !== undefined) {
          actual = actuals[productId.replace('PRODUCT', '')];
        }
        
        if (actual === null) return;

        const pred = p.predicted_demand || 0;
        const err = pred - actual;
        const absErr = Math.abs(err);
        const sqErr = err * err;

        sumSq += sqErr;
        sumBias += err;
        pairs += 1;

        if (actual !== 0) {
          const pct = absErr / Math.abs(actual);
          sumAbsPct += pct;
          countPct += 1;
        }

        errors.push({
          product_id: p.product_id,
          predicted: pred,
          actual: actual,
          error: err
        });

        matchedProducts.push(`P${p.product_id}`);
      });

      console.log('Matched products:', matchedProducts);
      console.log('Pairs found:', pairs);

      if (pairs === 0) {
        // Show more detailed error information
        const productIdsInPredictions = allData.slice(0, 10).map(p => `P${p.product_id}`).join(', ');
        const productIdsInActuals = Object.keys(actuals).slice(0, 10).join(', ');
        
        resultEl.innerHTML = `
          <span style="color:#ff006e">
            ‚ùå No matching product IDs found!<br><br>
            <strong>Possible issues:</strong><br>
            1. Product ID format mismatch<br>
            2. Different ID ranges<br><br>
            <strong>Prediction IDs (first 10):</strong><br>
            ${productIdsInPredictions}<br><br>
            <strong>Your Actual IDs (first 10):</strong><br>
            ${productIdsInActuals}<br><br>
            <strong>Format examples that work:</strong><br>
            ‚Ä¢ 83, 45 (just the number)<br>
            ‚Ä¢ PRODUCT83, 45<br>
            ‚Ä¢ P83, 45<br>
            ‚Ä¢ Product83, 45
          </span>
        `;
        return;
      }

      const rmse = Math.sqrt(sumSq / pairs);
      const mape = countPct > 0 ? (sumAbsPct / countPct) * 100 : null;
      const bias = sumBias / pairs;
      const accuracyApprox = mape != null ? Math.max(0, 100 - mape) : null;

      lastAccuracy = { rmse, mape, bias, accuracyApprox, pairs, matchedProducts };

      // Update metrics display
      document.getElementById('accuracyMetric').textContent = 
        accuracyApprox != null ? accuracyApprox.toFixed(1) + '%' : 'N/A';
      document.getElementById('rmseMetric').textContent = rmse.toFixed(2);
      document.getElementById('biasMetric').textContent = bias.toFixed(2);
      document.getElementById('samplesMetric').textContent = pairs;

      // Update main stats
      if (accuracyApprox != null) {
        document.getElementById('accuracyScore').textContent = accuracyApprox.toFixed(1) + '%';
        document.getElementById('accuracySub').textContent = 'Based on ' + pairs + ' product(s)';
      }

      // Generate detailed result
      let resultHTML = '<strong>‚úÖ Accuracy Calculation Successful!</strong><br>';
      resultHTML += `‚Ä¢ <strong>Matched Products:</strong> ${matchedProducts.slice(0, 10).join(', ')}`;
      if (matchedProducts.length > 10) {
        resultHTML += ` and ${matchedProducts.length - 10} more`;
      }
      resultHTML += `<br>`;
      resultHTML += `‚Ä¢ <strong>Overall Accuracy:</strong> ${accuracyApprox != null ? accuracyApprox.toFixed(1) + '%' : 'N/A'}<br>`;
      resultHTML += `‚Ä¢ <strong>RMSE:</strong> ${rmse.toFixed(2)}<br>`;
      resultHTML += `‚Ä¢ <strong>Average Bias:</strong> ${bias.toFixed(2)}<br>`;
      resultHTML += `‚Ä¢ <strong>Products Compared:</strong> ${pairs}<br>`;
      
      // Add interpretation
      resultHTML += `<br><span style="color:rgba(255,255,255,0.9); font-size:0.9em">`;
      if (accuracyApprox != null) {
        if (accuracyApprox > 90) {
          resultHTML += 'üèÜ <strong>Excellent accuracy!</strong> Your predictions are highly reliable.';
        } else if (accuracyApprox > 75) {
          resultHTML += 'üëç <strong>Good accuracy.</strong> Predictions are reasonably accurate.';
        } else if (accuracyApprox > 60) {
          resultHTML += 'üìä <strong>Moderate accuracy.</strong> Consider reviewing prediction parameters.';
        } else {
          resultHTML += 'üìâ <strong>Low accuracy.</strong> Significant adjustments may be needed.';
        }
      }
      resultHTML += '</span>';

      resultEl.innerHTML = resultHTML;

      // Add to chatbot
      let chatMessage = `üéØ Accuracy calculated for ${pairs} products! `;
      if (accuracyApprox != null) {
        chatMessage += `Overall accuracy: ${accuracyApprox.toFixed(1)}%. `;
        if (accuracyApprox > 90) chatMessage += 'Excellent predictions! üèÜ';
        else if (accuracyApprox > 75) chatMessage += 'Good accuracy! üëç';
      }
      addChatMessage('bot', chatMessage);
    }

    function updateAlerts() {
      if (allData.length === 0) return;

      const lowStockThreshold = 50;
      const criticalThreshold = 30;
      
      const now = new Date();
      const timeStr = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
      
      // Critical Stock Alert
      const criticalStock = allData.filter(p => p.current_stock < criticalThreshold);
      if (criticalStock.length > 0) {
        const topCritical = criticalStock.slice(0, 3);
        const list = topCritical.map(p => `P${p.product_id}(${p.current_stock})`).join(', ');
        const extra = criticalStock.length > 3 ? ` +${criticalStock.length - 3} more` : '';
        document.getElementById('criticalAlert').textContent = 
          `${criticalStock.length} products with stock < ${criticalThreshold}. Immediate action required for: ${list}${extra}.`;
        document.getElementById('criticalTime').textContent = `Updated ${timeStr}`;
      } else {
        document.getElementById('criticalAlert').textContent = 'No critical stock issues detected.';
        document.getElementById('criticalTime').textContent = `Updated ${timeStr}`;
      }
      
      // Restock Recommendations
      const restockNeeded = allData.filter(p => (p.recommended_restock || 0) > 0);
      if (restockNeeded.length > 0) {
        const topRestock = restockNeeded.slice(0, 3);
        const list = topRestock.map(p => `P${p.product_id}(${p.recommended_restock})`).join(', ');
        const extra = restockNeeded.length > 3 ? ` +${restockNeeded.length - 3} more` : '';
        document.getElementById('restockAlert').textContent = 
          `${restockNeeded.length} products need restocking. Top recommendations: ${list}${extra}.`;
        document.getElementById('restockTime').textContent = `Updated ${timeStr}`;
      } else {
        document.getElementById('restockAlert').textContent = 'No restock recommendations at this time.';
        document.getElementById('restockTime').textContent = `Updated ${timeStr}`;
      }
      
      // Demand Insights
      const topDemand = [...allData]
        .sort((a, b) => (b.predicted_demand || 0) - (a.predicted_demand || 0))
        .slice(0, 5);
      const demandList = topDemand.map(p => `P${p.product_id}(${p.predicted_demand})`).join(', ');
      const totalDemand = allData.reduce((sum, p) => sum + (p.predicted_demand || 0), 0);
      document.getElementById('demandAlert').textContent = 
        `Total predicted demand: ${Math.round(totalDemand)} units. Highest demand products: ${demandList}.`;
      document.getElementById('demandTime').textContent = `Updated ${timeStr}`;
      
      // Healthy Inventory
      const adequateStock = allData.filter(p => p.current_stock >= lowStockThreshold).length;
      const percentage = Math.round((adequateStock / allData.length) * 100);
      document.getElementById('healthyAlert').textContent = 
        `${percentage}% of products (${adequateStock}/${allData.length}) have adequate stock levels.`;
      document.getElementById('healthyTime').textContent = `Updated ${timeStr}`;
    }

    function exportCSV() {
      if (allData.length === 0) {
        alert('No data to export!');
        return;
      }

      const headers = ['Product ID', 'Total Sales', 'Current Stock', 'Predicted Demand', 'Recommended Restock', 'Status'];
      const rows = allData.map(p => {
        const status = p.current_stock < 30 ? 'Critical' : p.current_stock < 50 ? 'Low' : 'Adequate';
        return [
          p.product_id,
          p.total_sales,
          p.current_stock,
          p.predicted_demand,
          p.recommended_restock,
          status
        ];
      });

      let csv = headers.join(',') + '\n';
      csv += rows.map(row => row.join(',')).join('\n');

      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'inventory_predictions_' + new Date().toISOString().split('T')[0] + '.csv';
      a.click();
      URL.revokeObjectURL(url);

      addChatMessage('bot', `‚úÖ Exported ${allData.length} products to CSV file.`);
    }

    // Chatbot Functions
    function toggleChatbot() {
      const win = document.getElementById('chatbotWindow');
      const toggle = document.getElementById('chatbotToggle');
      
      win.classList.toggle('active');
      toggle.classList.toggle('pulse');
      
      if (win.classList.contains('active')) {
        // Set initial time
        const initTime = document.getElementById('initTime');
        if (initTime) {
          initTime.textContent = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }
        
        // Focus on input
        setTimeout(() => {
          document.getElementById('chatInput').focus();
        }, 300);
      }
    }

    function addChatMessage(sender, text) {
      const container = document.getElementById('chatMessages');
      const messageDiv = document.createElement('div');
      messageDiv.className = 'chat-message ' + sender;
      
      const bubble = document.createElement('div');
      bubble.className = 'message-bubble ' + sender;
      bubble.innerHTML = text.replace(/\n/g, '<br>');
      
      const timeSpan = document.createElement('div');
      timeSpan.className = 'message-time';
      timeSpan.textContent = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
      
      bubble.appendChild(timeSpan);
      messageDiv.appendChild(bubble);
      container.appendChild(messageDiv);
      
      // Scroll to bottom
      container.scrollTop = container.scrollHeight;
    }

    function clearChat() {
      const container = document.getElementById('chatMessages');
      container.innerHTML = `
        <div class="chat-message bot">
          <div class="message-bubble bot">
            Chat cleared. How can I help you with your inventory today? ü§ñ
            <div class="message-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
          </div>
        </div>
      `;
    }

    function sendChat() {
      const input = document.getElementById('chatInput');
      const text = input.value.trim();
      if (!text) return;
      
      addChatMessage('user', text);
      input.value = '';
      updateSendButton();
      
      setTimeout(() => handleBotReply(text), 500);
    }

    function handleBotReply(q) {
      const text = q.toLowerCase();

      if (allData.length === 0) {
        addChatMessage('bot', 'Please click "Load Predictions" first so I can analyze your inventory.');
        return;
      }

      if (text.includes('low stock') || text.includes('critical stock')) {
        const lowStockThreshold = 50;
        const criticalThreshold = 30;
        
        const lowStock = allData.filter(p => p.current_stock < lowStockThreshold);
        const criticalStock = allData.filter(p => p.current_stock < criticalThreshold);
        
        if (criticalStock.length > 0) {
          const list = criticalStock.slice(0, 5).map(p => 
            `P${p.product_id} (stock: ${p.current_stock})`
          ).join(', ');
          addChatMessage('bot', `üö® CRITICAL ALERT: ${criticalStock.length} products have stock below ${criticalThreshold}: ${list}. Immediate action required!`);
        } else if (lowStock.length > 0) {
          const list = lowStock.slice(0, 5).map(p => 
            `P${p.product_id} (stock: ${p.current_stock})`
          ).join(', ');
          addChatMessage('bot', `‚ö†Ô∏è Low Stock: ${lowStock.length} products have stock below ${lowStockThreshold}: ${list}. Consider restocking soon.`);
        } else {
          addChatMessage('bot', '‚úÖ Great news! No low stock items detected. All products have adequate inventory levels.');
        }
        return;
      }

      if (text.includes('highest demand') || text.includes('top demand') || text.includes('best selling')) {
        const top = [...allData]
          .sort((a, b) => (b.predicted_demand || 0) - (a.predicted_demand || 0))
          .slice(0, 10);
        
        let response = `üìà Top ${Math.min(10, top.length)} Products by Predicted Demand:\n\n`;
        top.forEach((p, i) => {
          const rank = i < 3 ? ['ü•á', 'ü•à', 'ü•â'][i] : `${i+1}.`;
          response += `${rank} P${p.product_id}: ${p.predicted_demand} units\n`;
          response += `   Stock: ${p.current_stock} | Sales: ${p.total_sales}\n`;
        });
        
        addChatMessage('bot', response);
        return;
      }

      if (text.includes('restock') || text.includes('reorder') || text.includes('replenish')) {
        const restock = allData.filter(p => (p.recommended_restock || 0) > 0);
        
        if (restock.length === 0) {
          addChatMessage('bot', '‚úÖ No products currently require restocking according to our predictions. All inventory levels are optimal!');
        } else {
          const urgent = restock.filter(p => p.current_stock < 30);
          const soon = restock.filter(p => p.current_stock >= 30 && p.current_stock < 50);
          
          let response = `üîÑ Restock Recommendations (${restock.length} products):\n\n`;
          
          if (urgent.length > 0) {
            response += `üö® URGENT (Stock < 30):\n`;
            urgent.slice(0, 5).forEach(p => {
              response += `‚Ä¢ P${p.product_id}: Restock ${p.recommended_restock} units (Current: ${p.current_stock})\n`;
            });
            response += `\n`;
          }
          
          if (soon.length > 0) {
            response += `‚ö†Ô∏è SOON (Stock 30-49):\n`;
            soon.slice(0, 5).forEach(p => {
              response += `‚Ä¢ P${p.product_id}: Restock ${p.recommended_restock} units (Current: ${p.current_stock})\n`;
            });
          }
          
          if (restock.length > 10) {
            response += `\n... and ${restock.length - 10} more products.`;
          }
          
          addChatMessage('bot', response);
        }
        return;
      }

      if (text.includes('accuracy') || text.includes('performance') || text.includes('error')) {
        if (!lastAccuracy) {
          addChatMessage('bot', 'üìä To calculate prediction accuracy:\n\n' +
            '1. Load predictions first\n' +
            '2. Paste actual sales data in this format:\n' +
            '   83, 45\n' +
            '   86, 42\n' +
            '3. Click "Calculate Accuracy"\n\n' +
            'The system will match product IDs and compute metrics.');
        } else {
          let response = `üéØ Prediction Accuracy Analysis:\n\n`;
          response += `‚Ä¢ Products Analyzed: ${lastAccuracy.pairs}\n`;
          if (lastAccuracy.matchedProducts) {
            response += `‚Ä¢ Matched: ${lastAccuracy.matchedProducts.slice(0, 5).join(', ')}`;
            if (lastAccuracy.matchedProducts.length > 5) {
              response += ` and ${lastAccuracy.matchedProducts.length - 5} more`;
            }
            response += `\n`;
          }
          if (lastAccuracy.accuracyApprox != null) {
            response += `‚Ä¢ Overall Accuracy: ${lastAccuracy.accuracyApprox.toFixed(1)}%\n`;
            response += lastAccuracy.accuracyApprox > 90 ? `  üèÜ Excellent accuracy!\n` :
                       lastAccuracy.accuracyApprox > 75 ? `  üëç Good predictions\n` :
                       lastAccuracy.accuracyApprox > 60 ? `  üìä Moderate accuracy\n` :
                       `  üìâ Needs improvement\n`;
          }
          response += `‚Ä¢ RMSE: ${lastAccuracy.rmse.toFixed(2)}\n`;
          response += `‚Ä¢ Average Bias: ${lastAccuracy.bias.toFixed(2)} `;
          if (lastAccuracy.bias > 0) response += `(over-prediction)`;
          else if (lastAccuracy.bias < 0) response += `(under-prediction)`;
          else response += `(perfect balance)`;
          
          addChatMessage('bot', response);
        }
        return;
      }

      if (text.includes('summary') || text.includes('overview') || text.includes('status')) {
        const lowStockThreshold = 50;
        const lowStock = allData.filter(p => p.current_stock < lowStockThreshold).length;
        const restock = allData.filter(p => (p.recommended_restock || 0) > 0).length;
        const demand = allData.reduce((s, p) => s + (p.predicted_demand || 0), 0);
        const sales = allData.reduce((s, p) => s + (p.total_sales || 0), 0);
        
        let response = `üìä Inventory Summary:\n\n`;
        response += `‚Ä¢ Total Products: ${allData.length}\n`;
        response += `‚Ä¢ Low Stock Items: ${lowStock}\n`;
        response += `‚Ä¢ Restock Recommended: ${restock}\n`;
        response += `‚Ä¢ Total Predicted Demand: ${Math.round(demand)} units\n`;
        response += `‚Ä¢ Total Sales: ${sales}\n`;
        response += `‚Ä¢ Avg Stock Level: ${Math.round(allData.reduce((s, p) => s + p.current_stock, 0) / allData.length)}\n\n`;
        
        if (lowStock === 0 && restock === 0) {
          response += `‚úÖ Excellent! Your inventory is in great shape.`;
        } else if (lowStock > 5) {
          response += `‚ö†Ô∏è Attention needed: ${lowStock} products are low in stock.`;
        } else {
          response += `üìã Monitor ${restock} products for upcoming restocking.`;
        }
        
        addChatMessage('bot', response);
        return;
      }

      if (text.includes('help') || text.includes('what can you do')) {
        addChatMessage('bot', `ü§ñ I can help you with:\n\n` +
          `üìä **Inventory Analysis**\n` +
          `‚Ä¢ Check low stock items\n` +
          `‚Ä¢ Find highest demand products\n` +
          `‚Ä¢ Get restock recommendations\n` +
          `‚Ä¢ View inventory summary\n\n` +
          `üéØ **Accuracy & Metrics**\n` +
          `‚Ä¢ Calculate prediction accuracy\n` +
          `‚Ä¢ Explain RMSE and bias\n` +
          `‚Ä¢ Compare actual vs predicted\n\n` +
          `üé§ **Voice Commands**\n` +
          `‚Ä¢ Click the üé§ button to use voice\n` +
          `‚Ä¢ Say "show low stock"\n` +
          `‚Ä¢ Say "highest demand"\n` +
          `‚Ä¢ Say "restock recommendations"\n\n` +
          `Try asking: "What products need restocking?" or "Give me a summary"`);
        return;
      }

      if (text.includes('hello') || text.includes('hi') || text.includes('hey')) {
        addChatMessage('bot', `Hello! üëã I'm your Inventory AI Assistant. I can help you analyze stock levels, predict demand, and optimize your inventory. What would you like to know about your inventory today?`);
        return;
      }

      if (text.includes('thank')) {
        addChatMessage('bot', `You're welcome! üòä Let me know if you need any more help with your inventory analysis.`);
        return;
      }

      // Default response for unrecognized queries
      addChatMessage('bot', `I understand you're asking about "${q}". I can help you with:\n\n` +
        `‚Ä¢ üìä Low stock alerts and critical items\n` +
        `‚Ä¢ üìà Demand forecasting and top products\n` +
        `‚Ä¢ üîÑ Restock recommendations\n` +
        `‚Ä¢ üéØ Prediction accuracy analysis\n` +
        `‚Ä¢ üìã Overall inventory summary\n\n` +
        `Try asking more specifically, like "Which products have the highest demand?" or "Show me low stock items."`);
    }

    // Initialize chatbot with current time
    document.getElementById('initTime').textContent = 
      new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
      
    // Initialize send button state
    updateSendButton();
    
    // Initialize accuracy preview
    updateAccuracyPreview();
  </script>
</body>
</html>
